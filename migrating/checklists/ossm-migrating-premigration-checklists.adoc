:_mod-docs-content-type: ASSEMBLY
[id="ossm-migrating-premigration-checklists"]
= Premigration checklists
include::_attributes/common-attributes.adoc[]
:context: ossm-migrating-premigration-checklists

toc::[]

.Before you begin

* You have read "Migrating from Service Mesh 2 to Service Mesh 3".
* You have read and understand the xref:../../migrating/checklists/ossm-migrating-read-me.adoc#ossm-2-and-3-differences_ossm-migrating-read-me[differences between OpenShift Service Mesh 2 and OpenShift Service Mesh 3].
* You have reviewed the xref:../../migrating/reference/ossm-migrating-references.adoc[Migrating references] material.
* You want to migrate from {SMProduct} 2 to {SMProduct} 3.
* You are running {SMProduct} {SMv2Version}.
* You have upgraded your `ServiceMeshControlPlane` resource to the latest version.
* If you are using the {KialiProduct}, you are running the latest version.
* You have installed the {SMProduct} Operator 3. To install the {SMProduct} 3 Operator, see: xref:../../install/ossm-installing-openshift-service-mesh.adoc[Installing OpenShift Service Mesh]

[IMPORTANT]
====
You must complete the following checklists before you can begin migrating your deployment and workloads.
====

[id="disable-add-ons-and-reconfigure-replacements_{context}"]
== Disable add-ons and reconfigure replacements

* [ ] Disable Prometheus in your `ServiceMeshControlPlane` resource: `spec.addons.prometheus.enabled=false`
** [ ] Configure the `ServiceMeshControlPlane` with OpenShift Monitoring as the replacement. These instructions also include installing a standalone `Kiali` resource. Both can be done at the same time. link:https://docs.redhat.com/en/documentation/openshift_container_platform/4.17/html/service_mesh/service-mesh-2-x#ossm-integrating-with-user-workload-monitoring_observability[Integration user-workload monitoring]
** [ ] If you are not using OpenShift monitoring, see: link:https://docs.redhat.com/en/documentation/red_hat_openshift_service_on_aws/4/html/service_mesh/service-mesh-2-x#integration-with-external-prometheus-installation[Integration with external Prometheus installation].

* [ ] Disable tracing in your `ServiceMeshControlPlane` resource: `spec.tracing.type=None`
** [ ] Configure the `ServiceMeshControlPlane` with OpenShift Distributed Tracing as the replacement: link:https://docs.redhat.com/en/documentation/openshift_container_platform/4.17/html/service_mesh/service-mesh-2-x#ossm-configuring-distr-tracing-tempo_observability[Configuring {TempoName} and the Red{nbsp}Hat build of OpenTelemetry].

* [ ] Disable Kiali in your `ServiceMeshControlPlane` resource: `spec.addons.kiali.enabled=false`
** [ ] If you did not create a standalone `Kiali` resource as part of Prometheus or tracing, see: "Using {KialiProduct}".

[id="migrate-to-explicitly-managed-routes_{context}"]
== Migrate to explicitly managed routes

Automatic route creation, also known as Istio OpenShift Routing (IOR), is a deprecated feature that is disabled by default for any `ServiceMeshControlPlane` resource created using {SMProduct} 2.5 and later. To move from {SMProduct} 2 to {SMProduct} 3, you need to migrate from IOR to explicitly-managed routes.

If you already moved to explicitly-managed routes in {SMProduct} 2, then continue to gateway injection.

* [ ] Migrate from Istio OpenShift Routing (IOR) to to explicitly-managed routes: link:https://docs.redhat.com/en/documentation/openshift_container_platform/4.17/html/service_mesh/service-mesh-2-x#ossm-route-migration[Service Mesh route migration].

[id="migrate-to-gateway-injection_{context}"]
== Migrate to gateway injection

Gateways were controlled by the `ServiceMeshControlPlane` (SMCP) resource in {SMProduct} 2. The {SMProduct} 3 control plane does not manage gateways so you must migrate from SMCP-Defined gateways to gateway injection.

* [ ] link:https://docs.redhat.com/en/documentation/openshift_container_platform/4.17/html/service_mesh/service-mesh-2-x#ossm-gateway-migration[Service Mesh gateway migration].

[id="disable-network-policy-management_{context}"]
== Disable network policy management

If you do not want your network policies in place during your migration:

* [ ] Disable network policy management in the {SMProduct} 2 `ServiceMeshControlPlane` resource: `spec.security.manageNetworkPolicy=false`.
* [ ] Complete the rest of the checklists.
* [ ] Migrate your deployment and workloads.
* [ ] Manually recreate your network policies after you have migrated your workloads.

If you want your network policies in place during your migration:

* [ ] Manually xref:../../migrating/checklists/ossm-migrating-network-policies.adoc#ossm-migrating-network-policies-setup-during-migration_ossm-migrating-network-policies[set up network policies to use during migration].
* [ ] Disable network policy management in the {SMProduct} 2 `ServiceMeshControlPlane` resource: `spec.security.manageNetworkPolicy=false`.
* [ ] Complete the rest of the checklists.
* [ ] Migrate your deployment and workloads.

[id="disable-grafana-in-service-mesh-2_{context}"]
== Disable Grafana in {SMProduct} 2

Grafana is not supported in {SMProduct} 3, and must be disabled in your {SMProduct} 2 `ServiceMeshControlPlane`.

  * [ ] Disable Grafana in your {SMProduct} 2 `ServiceMeshControlPlane`: `spec.addons.grafana.enabled=false`.

include::modules/ossm-migrating-premigration-checklists-resource-files.adoc[leveloffset=+1]

[id="find-your-deployment-model_{context}"]
== Find your deployment model

Run the following command to find your deployment model:

[source,terminal]
----
oc get smcp <smcp-name> -n <smcp-namespace> -o jsonpath='{.spec.mode}'
----

[NOTE]
====
If you did not set a value for the `.spec.mode` parameter in your `ServiceMeshControlPlane` resource, your deployment is multitenant.
====

[id="migrate-based-on-your-deployment-model_{context}"]
== Migrate based on your deployment model

If you are not using the cert-manager tool with your deployment, you are ready to migrate your deployment.

* xref:../../migrating/multitenant/ossm-migrating-multitenant.adoc#ossm-migrating-multitenant[Multitenant migration guide]
* xref:../../migrating/cluster-wide/ossm-migrating-cluster-wide.adoc#ossm-migrating-cluster-wide[Cluster-wide migration guide]

If you are unsure, you can check if you are using the cert-manager tool with your deployment.

include::modules/ossm-migrating-premigration-checklists-using-the-cert-manager-tool-with-your-deployment.adoc[leveloffset=+1]

.Next steps for migrating with the cert-manager tool

There are some configurations you must complete first before you can start migrating your deployments.

* xref:../../migrating/multitenant/ossm-migrating-multitenant.adoc#migrating-multitenant-with-cert-manager_ossm-migrating-multitenant[Migrating a multitenant deployment with the cert-manager tool]
* xref:../../migrating/cluster-wide/ossm-migrating-cluster-wide.adoc#ossm-cluster-wide-migration-methods_ossm-migrating-cluster-wide[Cluster-wide migration methods]

//Per engineering, uncomment Final check after GA
//move to module when uncommenting
//== Final check before migrating your deployment and workloads

//Once you have configured your `ServiceMeshControlPlane` according to the checklists, you can run the following script to detect any issues with your environment:

//* [ ] Run the [migration-checker script](migration-checker.sh) to detect any issues with your environment.

[role="_additional-resources"]
[id="additional-resources-checklists_{context}"]
== Additional resources

* xref:../../observability/kiali/ossm-kiali-assembly.adoc[Using {kialiproduct}]
