// Module included in the following assemblies:
// install/ossm-sidecar-injection

:_mod-docs-content-type: PROCEDURE
[id="ossm-enabling-sidecar-injection-istio-revision-tag-resource_{context}"]
= Enabling sidecar injection with namespace labels and an IstioRevisionTag resource

To use the `istio-injection=enabled` label when your revision name is not `default`, you must create an `IstioRevisionTag` resource with the name `default` that references your `Istio` resource.

//Prereqs lifted from existing content https://docs.redhat.com/en/documentation/red_hat_openshift_service_mesh/3.0/html/installing/ossm-sidecar-injection
//any changes made will need to be part of refactoring Jira issue OSSM-9078 so content is consistent
.Prerequisites

* You have installed the {SMProductName} Operator, created an `{istio}` resource, and the Operator has deployed {istio}.
* You have created the `IstioCNI` resource, and the Operator has deployed the necessary `IstioCNI` pods.
* You have created the namespaces that are to be part of the mesh, and they are discoverable by the {istio} control plane.
* Optional: You have deployed the workloads to be included in the mesh. In the following examples, the Bookinfo has been deployed to the `bookinfo` namespace, but sidecar injection (step 5 in "Deploying the Bookinfo application" procedure) has not been configured. For more information, see "Deploying the Bookinfo application".

.Procedure

. Find the name of your `Istio` resource by running the following command:
+
[source,terminal]
----
$ oc get istio
----
+
.Example output
[source,terminal]
----
NAME      REVISIONS   READY   IN USE   ACTIVE REVISION   STATUS    VERSION   AGE
default   1           1       1        default-v1-24-3   Healthy   v1.24.3   11s
----
+
In this example, the `Istio` resource has the name `default`, but the underlying revision is called `default-v1-24-3`.

. Create the `IstioRevisionTag` resource in a YAML file:
+
.Example `IstioRevistionTag` resource YAML file
[source,yaml]
----
apiVersion: sailoperator.io/v1
kind: IstioRevisionTag
metadata:
  name: default
spec:
  targetRef:
    kind: Istio
    name: default
----

. Apply the `IstioRevisionTag` resource by running the following command:
+
[source,terminal]
----
$ oc apply -f istioRevisionTag.yaml
----

. Verify that the `IstioRevisionTag` resource has been created successfully by running the following command:
+
[source,terminal]
----
$ oc get istiorevisiontags.sailoperator.io
----
+
.Example output
[source,terminal]
----
NAME      STATUS    IN USE   REVISION          AGE
default   Healthy   True     default-v1-24-3   4m23s
----
+
In this example, the new tag is referencing your active revision, `default-v1-24-3`. Now you can use the `istio-injection=enabled` label as if your revision was called `default`.
+
//lifted from existing content https://docs.redhat.com/en/documentation/red_hat_openshift_service_mesh/3.0/html/installing/ossm-sidecar-injection
//any changes made will need to be part of refactoring Jira issue OSSM-9078 so content is consistent

. Confirm that the pods are running without sidecars by running the following command. Any workloads that are already running in the desired namespace should show `1/1` containers in the `READY` column.
+
[source,terminal]
----
$ oc get pods -n bookinfo
----
+
.Example output
[source,terminal]
----
NAME                             READY   STATUS    RESTARTS   AGE
details-v1-65cfcf56f9-gm6v7      1/1     Running   0          4m55s
productpage-v1-d5789fdfb-8x6bk   1/1     Running   0          4m53s
ratings-v1-7c9bd4b87f-6v7hg      1/1     Running   0          4m55s
reviews-v1-6584ddcf65-6wqtw      1/1     Running   0          4m54s
reviews-v2-6f85cb9b7c-w9l8s      1/1     Running   0          4m54s
reviews-v3-6f5b775685-mg5n6      1/1     Running   0          4m54s
----

. Apply the injection label to the `bookinfo` namespace by running the following command:
+
[source,terminal]
----
$ oc label namespace bookinfo istio-injection=enabled \
namespace/bookinfo labeled
----

. To ensure sidecar injection is applied, redeploy the workloads in the `bookinfo` namespace by running the following command:
+
[source,terminal]
----
$ oc -n bookinfo rollout restart deployments
----

.Verification

. Verify the rollout by running the following command and confirming that the new pods display `2/2` containers in the `READY` column:
+
[source,terminal]
----
$ oc get pods -n bookinfo
----
+
.Example output
[source,terminal]
----
NAME                              READY   STATUS    RESTARTS   AGE
details-v1-7745f84ff-bpf8f        2/2     Running   0          55s
productpage-v1-54f48db985-gd5q9   2/2     Running   0          55s
ratings-v1-5d645c985f-xsw7p       2/2     Running   0          55s
reviews-v1-bd5f54b8c-zns4v        2/2     Running   0          55s
reviews-v2-5d7b9dbf97-wbpjr       2/2     Running   0          55s
reviews-v3-5fccc48c8c-bjktn       2/2     Running   0          55s
----